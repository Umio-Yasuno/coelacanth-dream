---
title: "見た目から実用性と速度へ"
date: 2020-01-23T03:56:12+09:00
draft: false
tags: [ "Hugo", "CSS" ]
keywords: [ "", ]
categories: [ "Diary", ]
noindex: true
---

最近このサイトのレイアウトやCSSをちょくちょくいじってきた。  


まずこのサイトのデザインは、自分がCSSを覚えながらやってるものだから、変更点のほとんどが計画のない思いつきによるものだ。  
そのせいで、「あれ、気になってたあの部分ってどうしたっけ」となりやすい。  
頭の中の整理として、一度書くこととした。  

### やったこと一覧
 * [インラインCSS](#インラインcss)
 * [レンダリングパス最適化](#レンダリングパス最適化)
 * [その他微調整](#その他微調整)

#### インラインCSS
このサイトは軽い。  
JavaScriptや、特別にフォントを用意してはいないし、それぞれのページやCSSも規模が小さいから当たり前だ。  
Googleの PageSpeed Insights でも基本100点を取っている。  
が、自分のスマホで見てみると引っ掛かりを覚えることがある。  
原因はサイトよりも Snapdragon 410――28nm LP、Cortex-A53 4-Core、Adreno 306という構成だ、GPS機能はまあまあ優秀――にメモリ2GB（LPDDR2かLPDDR3なのかは知らない）を搭載したスマホを使い続けていることだとは思うが、それでも快適に見られるくらいに工夫を施したいとなるのは自然だろう。  

そこでインラインCSSに手を出した。  
少し変更するとサイト内のページ全てに書き換えが発生し、コミットの中身がパンパンでよく確認できないのを嫌い、今まで速度向上の手段として頭の中にあっても、まだいいかと後回しにしていた。  
その問題は依然として残っているが、性能、速度向上手段は常に何かとのトレードオフであるし、今回はそれがコミット内容が煩雑になるというもので、  
それはインライン部分が完成に近付けば落ち着くはずだ。  

<br>
inline-css.htmlにまとめて書き、baseof.htmlに組み込むように記述している。  
以下に一部を載せているが、改行を減らしながら読みやすさは残そうとしたが、結局汚くなってしまった。  
元はそのままで、一部だけminify化できれば楽なのだけれど、調べた所Hugoのページビルド時にまとめてやるしかなく、どうしてもやりたいなら自分で別にスクリプトを書く必要があるらしい。  
そこまでの必要性には迫られていないため、とりあえず後回し。  

Hugoにある機能のおかげで、ページごとに必要な部分最低限にできるのはありがたい。  

<pre><code>inline-css.htmlの一部をさらに省略したもの :

{{- if .IsNode -}}
h2 {color: #FF9900;font: normal 1.4rem sans-serif}
	{{- if .Section -}}
.posts {display: flex;flex-flow: column wrap;line-height: 1.6em;text-align:justify-all;}
	{{- end -}}
{{- else if .IsPage -}}
h2, h3, h4 {color: #FF9900;font: normal 1em sans-serif}
{{- end -}}
</code></pre>

#### レンダリングパス最適化
こちらのサイトを参考に、'\<link rel="stylesheet"\>'の位置を調節した。  
[HTTP2 を前提とした HTML+CSS コンポーネントのレンダリングパス最適化について | blog.jxck.io](https://blog.jxck.io/entries/2016-02-15/loading-css-over-http2.html)  

具体的には、ホームでまず見ることになる title部と section部のCSSをインラインで記述し、スクロールしなければ見ない位置にある footer部とアニメーションは外部CSSに分けて、'\<link rel="stylesheet"\>'をその直前に置いた。  

インラインCSSと合わせたこれは結構効果があり、ローディングを示すプログレッシブバーが複数段に分けて進み、見ていて気持ちが良い。  
Preloadもちゃんと書いてるけど、普段使ってるブラウザ（Firefox）ではそういった機能をブロックするよう設定しているため、そちらは実感できない。  
ただ PageSpeed Insights を試すと、スコアは元々100だから変わらないとして、内訳を見るとモバイルで 0.2 ~ 0.5 秒の短縮が確認できた。  

ちなみに footer.cssへのPreloadを書き忘れた時に試したらスコアが下がり、レンダリングをブロックしているリソースとされたため、上記Jxck氏のブログにあった、\<link\>より上の要素も止まってしまう、という仕様はそのままなのだろうか。  

#### その他微調整
flexbox を一部に使うようにしたり、時刻表記をyyyy-mm-ddに変えたり、タグを正しいとされてる使い方に直したり、  
section部の下に線を引くようにしたり {{< comple >}}最初は \<hr class=""\> でやってたけど、CSSで border-bottom を指定した方が楽だと気付き、変えた。ついでに言えば他の方が作成したHugoテーマを見て真似した。実際読みやすいし、見栄えもいい{{< /comple >}}、  

ああそうだ、背景の表示方法をずっとマシにしたんだった。  
前は背景の固定がうまくいかず、中身をウィンドウ内に収まるブロックとし、それをスクロールする形を取っていたが、  
ページではないことから、いざスクロールしようとするとインプットが反映されるまでのラグが生まれてしまっていた。  
それを background-size、background-attachmentをきちんと指定することで解決した。  

ただ問題が全部なくなった訳ではなく、表示領域に収めているせいでブラウザのスクリーンショット機能を使ってページ全体を撮ると、一部が白背景のままになってしまう。  

こんな感じ。縦に長いためリンクを貼るだけとする。  
[Page Screenshot](/image/2020/01/23/page-screenshot.webp)  

意図しないスクリーンショットバスティングだが、そこまで深刻でもないしとりあえずは放置。  
今htmlに書いてる背景をbodyに移して、htmlには適当な背景を指定するとかで解決できるだろうか？  
それとスクリーンショット関連では、pointer-events: none を背景に指定していると実質無効化できることがわかったが、そこまで縛りたい訳ではなく、消しておいた。  

### 課題とか目標
#### page.css
必要なCSSを分割したが、記事ページに使うCSSはうまく分割できずサイズが大きめになってしまった。  
無理に分割すると、FOUC（flash of unstyled content）が発生してしまい、格好がつかない。  

追記部分はHugoのShortcodeで楽に書け、そういったものはShortcodeの一番上に\<link rel="stylesheet"\>を置くことで分割できる。  
だがそれは追記部分に適用したいCSSが微妙に多かったからで、他はそういう訳にもいかず、やってしまうといたずらにファイル数が増えてしまう。  
かといって page.css 全てをインラインにすると管理がめんどくさくなる。  

仕方なく page.css にレンダリングを一時ブロックされることを受け入れたが、課題としては依然残り続ける。  

#### Grid layout
雑多な margin から解放されると期待して試したが、うまくいかなかった。  
というかうまく反映させされなかった。  
既存コードを一部修正しての実装は難しく、思い切りやり直す必要があるのかもしれない。  

それも手間自体はかかるため、いつかの自分に後回し。  


